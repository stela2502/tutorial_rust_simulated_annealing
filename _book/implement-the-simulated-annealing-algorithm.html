<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Implement the Simulated Annealing Algorithm | Simulated Annealing in Rust</title>
  <meta name="description" content="<p>This Tutorial gives a short hands on example of how to read a table into Rust and run some calculations.
This should be a one day excercise and requires a previouse programming experience, but not necessarily Rust experience.</p>" />
  <meta name="generator" content="bookdown 0.42 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Implement the Simulated Annealing Algorithm | Simulated Annealing in Rust" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="<p>This Tutorial gives a short hands on example of how to read a table into Rust and run some calculations.
This should be a one day excercise and requires a previouse programming experience, but not necessarily Rust experience.</p>" />
  <meta name="github-repo" content="stela2502/tutorial_rust_simulated_annealing" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Implement the Simulated Annealing Algorithm | Simulated Annealing in Rust" />
  
  <meta name="twitter:description" content="<p>This Tutorial gives a short hands on example of how to read a table into Rust and run some calculations.
This should be a one day excercise and requires a previouse programming experience, but not necessarily Rust experience.</p>" />
  

<meta name="author" content="Stefan Lang" />


<meta name="date" content="2025-04-02" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="implementation.html"/>
<link rel="next" href="main.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="using-rust-to-implement-the-simulatied-annealing-algorithm.html"><a href="using-rust-to-implement-the-simulatied-annealing-algorithm.html"><i class="fa fa-check"></i><b>1</b> Using Rust to Implement the Simulatied Annealing Algorithm</a>
<ul>
<li class="chapter" data-level="1.1" data-path="using-rust-to-implement-the-simulatied-annealing-algorithm.html"><a href="using-rust-to-implement-the-simulatied-annealing-algorithm.html#the-problem"><i class="fa fa-check"></i><b>1.1</b> The Problem</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="using-rust-to-implement-the-simulatied-annealing-algorithm.html"><a href="using-rust-to-implement-the-simulatied-annealing-algorithm.html#the-data"><i class="fa fa-check"></i><b>1.1.1</b> The Data</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="using-rust-to-implement-the-simulatied-annealing-algorithm.html"><a href="using-rust-to-implement-the-simulatied-annealing-algorithm.html#simulated-annealing"><i class="fa fa-check"></i><b>1.2</b> Simulated annealing</a></li>
<li class="chapter" data-level="1.3" data-path="using-rust-to-implement-the-simulatied-annealing-algorithm.html"><a href="using-rust-to-implement-the-simulatied-annealing-algorithm.html#the-algorithm"><i class="fa fa-check"></i><b>1.3</b> The Algorithm</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introduction.html"><a href="introduction.html#examples"><i class="fa fa-check"></i><b>2.1</b> Examples</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="introduction.html"><a href="introduction.html#integers"><i class="fa fa-check"></i><b>2.1.1</b> Integers</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="introduction.html"><a href="introduction.html#create-a-new-rust-program"><i class="fa fa-check"></i><b>2.2</b> Create a new Rust program</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="implementation.html"><a href="implementation.html"><i class="fa fa-check"></i><b>3</b> Implementation</a>
<ul>
<li class="chapter" data-level="3.1" data-path="implementation.html"><a href="implementation.html#there-is-a-lot-of-new-stuff-in-this-function"><i class="fa fa-check"></i><b>3.1</b> There is a lot of new stuff in this function:</a></li>
<li class="chapter" data-level="3.2" data-path="implementation.html"><a href="implementation.html#add-a-test-for-this"><i class="fa fa-check"></i><b>3.2</b> Add a test for this</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="implement-the-simulated-annealing-algorithm.html"><a href="implement-the-simulated-annealing-algorithm.html"><i class="fa fa-check"></i><b>4</b> Implement the Simulated Annealing Algorithm</a>
<ul>
<li class="chapter" data-level="4.1" data-path="implement-the-simulated-annealing-algorithm.html"><a href="implement-the-simulated-annealing-algorithm.html#scaling-of-the-data"><i class="fa fa-check"></i><b>4.1</b> scaling of the data</a></li>
<li class="chapter" data-level="4.2" data-path="implement-the-simulated-annealing-algorithm.html"><a href="implement-the-simulated-annealing-algorithm.html#calculating-cluster-energy"><i class="fa fa-check"></i><b>4.2</b> Calculating Cluster Energy</a></li>
<li class="chapter" data-level="4.3" data-path="implement-the-simulated-annealing-algorithm.html"><a href="implement-the-simulated-annealing-algorithm.html#the-main-function"><i class="fa fa-check"></i><b>4.3</b> The main function</a></li>
<li class="chapter" data-level="4.4" data-path="implement-the-simulated-annealing-algorithm.html"><a href="implement-the-simulated-annealing-algorithm.html#and-funtions-to-plot-and-write-the-data"><i class="fa fa-check"></i><b>4.4</b> And Funtions to Plot and Write the Data</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="main.html"><a href="main.html"><i class="fa fa-check"></i><b>5</b> main.rs</a></li>
<li class="chapter" data-level="6" data-path="sharing-your-book.html"><a href="sharing-your-book.html"><i class="fa fa-check"></i><b>6</b> Sharing your book</a>
<ul>
<li class="chapter" data-level="6.1" data-path="sharing-your-book.html"><a href="sharing-your-book.html#publishing"><i class="fa fa-check"></i><b>6.1</b> Publishing</a></li>
<li class="chapter" data-level="6.2" data-path="sharing-your-book.html"><a href="sharing-your-book.html#pages"><i class="fa fa-check"></i><b>6.2</b> 404 pages</a></li>
<li class="chapter" data-level="6.3" data-path="sharing-your-book.html"><a href="sharing-your-book.html#metadata-for-sharing"><i class="fa fa-check"></i><b>6.3</b> Metadata for sharing</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="chapter" data-level="7" data-path="error-handling.html"><a href="error-handling.html"><i class="fa fa-check"></i><b>7</b> Error Handling in Rust</a>
<ul>
<li class="chapter" data-level="7.1" data-path="error-handling.html"><a href="error-handling.html#unrecoverable-errors-panic"><i class="fa fa-check"></i><b>7.1</b> 1. Unrecoverable Errors (<code>panic!</code>)</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="error-handling.html"><a href="error-handling.html#example"><i class="fa fa-check"></i><b>7.1.1</b> Example:</a></li>
<li class="chapter" data-level="7.1.2" data-path="error-handling.html"><a href="error-handling.html#when-to-use-panic"><i class="fa fa-check"></i><b>7.1.2</b> When to Use <code>panic!()</code></a></li>
<li class="chapter" data-level="7.1.3" data-path="error-handling.html"><a href="error-handling.html#handling-panics-gracefully"><i class="fa fa-check"></i><b>7.1.3</b> Handling Panics Gracefully</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="error-handling.html"><a href="error-handling.html#recoverable-errors-resultt-e"><i class="fa fa-check"></i><b>7.2</b> 2. Recoverable Errors (<code>Result&lt;T, E&gt;</code>)</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="error-handling.html"><a href="error-handling.html#example-1"><i class="fa fa-check"></i><b>7.2.1</b> Example:</a></li>
<li class="chapter" data-level="7.2.2" data-path="error-handling.html"><a href="error-handling.html#resultt-e-explanation"><i class="fa fa-check"></i><b>7.2.2</b> <code>Result&lt;T, E&gt;</code> Explanation</a></li>
<li class="chapter" data-level="7.2.3" data-path="error-handling.html"><a href="error-handling.html#common-ways-to-handle-resultt-e"><i class="fa fa-check"></i><b>7.2.3</b> Common Ways to Handle <code>Result&lt;T, E&gt;</code></a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="error-handling.html"><a href="error-handling.html#custom-errors-with-thiserror-and-anyhow"><i class="fa fa-check"></i><b>7.3</b> 3. Custom Errors with <code>thiserror</code> and <code>anyhow</code></a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="error-handling.html"><a href="error-handling.html#using-thiserror-for-custom-errors"><i class="fa fa-check"></i><b>7.3.1</b> Using <code>thiserror</code> for Custom Errors</a></li>
<li class="chapter" data-level="7.3.2" data-path="error-handling.html"><a href="error-handling.html#using-anyhow-for-simpler-error-handling"><i class="fa fa-check"></i><b>7.3.2</b> Using <code>anyhow</code> for Simpler Error Handling</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="error-handling.html"><a href="error-handling.html#summary-of-rust-error-handling-techniques"><i class="fa fa-check"></i><b>7.4</b> Summary of Rust Error Handling Techniques</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="testing.html"><a href="testing.html"><i class="fa fa-check"></i><b>8</b> Testing in Rust</a>
<ul>
<li class="chapter" data-level="8.1" data-path="testing.html"><a href="testing.html#writing-basic-unit-tests"><i class="fa fa-check"></i><b>8.1</b> 1. Writing Basic Unit Tests</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="testing.html"><a href="testing.html#example-2"><i class="fa fa-check"></i><b>8.1.1</b> Example:</a></li>
<li class="chapter" data-level="8.1.2" data-path="testing.html"><a href="testing.html#common-assertions"><i class="fa fa-check"></i><b>8.1.2</b> Common Assertions:</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="testing.html"><a href="testing.html#running-tests"><i class="fa fa-check"></i><b>8.2</b> 2. Running Tests</a></li>
<li class="chapter" data-level="8.3" data-path="testing.html"><a href="testing.html#testing-for-panics"><i class="fa fa-check"></i><b>8.3</b> 3. Testing for Panics</a></li>
<li class="chapter" data-level="8.4" data-path="testing.html"><a href="testing.html#using-resultt-e-in-tests"><i class="fa fa-check"></i><b>8.4</b> 4. Using <code>Result&lt;T, E&gt;</code> in Tests</a></li>
<li class="chapter" data-level="8.5" data-path="testing.html"><a href="testing.html#ignoring-tests"><i class="fa fa-check"></i><b>8.5</b> 5. Ignoring Tests</a></li>
<li class="chapter" data-level="8.6" data-path="testing.html"><a href="testing.html#benchmarking-with-bench"><i class="fa fa-check"></i><b>8.6</b> 6. Benchmarking with <code>#[bench]</code></a></li>
<li class="chapter" data-level="8.7" data-path="testing.html"><a href="testing.html#integration-tests"><i class="fa fa-check"></i><b>8.7</b> 7. Integration Tests</a>
<ul>
<li class="chapter" data-level="8.7.1" data-path="testing.html"><a href="testing.html#example-testsintegration_test.rs"><i class="fa fa-check"></i><b>8.7.1</b> Example <code>tests/integration_test.rs</code>:</a></li>
</ul></li>
<li class="chapter" data-level="8.8" data-path="testing.html"><a href="testing.html#testing-the-executable"><i class="fa fa-check"></i><b>8.8</b> 8. Testing the Executable</a>
<ul>
<li class="chapter" data-level="8.8.1" data-path="testing.html"><a href="testing.html#example-teststest_binary.rs"><i class="fa fa-check"></i><b>8.8.1</b> Example <code>tests/test_binary.rs</code>:</a></li>
</ul></li>
<li class="chapter" data-level="8.9" data-path="testing.html"><a href="testing.html#summary"><i class="fa fa-check"></i><b>8.9</b> Summary</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Simulated Annealing in Rust</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="implement-the-simulated-annealing-algorithm" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">Chapter 4</span> Implement the Simulated Annealing Algorithm<a href="implement-the-simulated-annealing-algorithm.html#implement-the-simulated-annealing-algorithm" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The idea behind this workshop is not to teach you how to implement the simulated annealing algorithm, but to show you how you can start to use Rust.
Therefore we will use Shamit’s R implementation and convert that to Rust.</p>
<div id="scaling-of-the-data" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> scaling of the data<a href="implement-the-simulated-annealing-algorithm.html#scaling-of-the-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This is the scale.01 function in R:</p>
<pre><code>scale.01 &lt;- function(v){
  sc.01 &lt;- (v-min(v))/(max(v)-min(v))
  sc.01
}</code></pre>
<p>In Rust I would like not exactly this functionality, but a function that converts our data object in place:</p>
<pre><code>    pub fn scale_01( &amp;mut self){
            for row in &amp;mut self.data {
                let mut min = f32::INFINITY;
                let mut max = f32::NEG_INFINITY;
                for i in 0..row.len(){
                    min = min.min(row[i]);
                    max = max.max(row[i]);
                    
                }
                // Now apply the scaling using the min/max in place
                for entry in row {
                    *entry = (*entry - min) / (max - min);  // In-place scaling
                }
            }
    }</code></pre>
</div>
<div id="calculating-cluster-energy" class="section level2 hasAnchor" number="4.2">
<h2><span class="header-section-number">4.2</span> Calculating Cluster Energy<a href="implement-the-simulated-annealing-algorithm.html#calculating-cluster-energy" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The R function uses a lot of R specific niceties like ‘which’ and ‘dist’ which we unfortunately need to implement in Rust.</p>
<pre><code># This function calculates the energy of a single cluster only (coi- cluster of interest)
calc.Ek &lt;- function(m,clus,coi){

  clus.d &lt;- m[which(clus==coi),]
  Ek &lt;- sum(dist(clus.d))
  Ek
}</code></pre>
<p>But that is not complicated:</p>
<pre><code>    /// Function to compute the Euclidean distance between rows of data
    fn euclidean_distance(&amp;self, i: usize, j: usize ) -&gt; f32 {
        let v1 = &amp;self.data[i];
        let v2 = &amp;self.data[j];
        let mut sum:f32 = 0.0;
        for i in 0..v1.len(){
            sum += (v1[i] - v2[i]).powi(2);
        }
        sum.sqrt()
    }
    
    /// Calculates the cluster energy
    fn calc_ek(&amp;self, clus: usize) -&gt; f32 {
        let ids = self.cluster_rows( clus );
        //println!(&quot;I found these cluster gene ids: {:?}&quot;,ids);
        let mut sum = 0.0;
        for i in 0..ids.len() {
            for j in i+1..ids.len() {
                //println!(&quot;adding {} ([{}][{}]) to the sum&quot;,self.store[ ids[i] ][ ids[j] ], ids[i], ids[j] );
                sum += self.euclidean_distance( ids[i], ids[j] );
            }
        }
        //println!(&quot;I found ek {sum}&quot;);
        sum
    }
    
    /// which rows are in cluster x?
    fn cluster_rows( &amp;self, clus: usize ) -&gt; Vec&lt;usize&gt;{
        let mut ret = Vec::&lt;usize&gt;::with_capacity( self.clusters.len() );
        for i in 0..self.clusters.len(){
             if self.clusters[i] == clus{
                ret.push(i);
             }
        }
        ret
    }
  </code></pre>
</div>
<div id="the-main-function" class="section level2 hasAnchor" number="4.3">
<h2><span class="header-section-number">4.3</span> The main function<a href="implement-the-simulated-annealing-algorithm.html#the-main-function" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This main function in R now runs the simulated annealing algorithm in R:</p>
<pre><code>#This is the main algorithm that performs the annealing. It takes the data,how
#many K we are looking for, The number of iterations to perform, starting
#temperature and the cooling factor.

sa.ok &lt;- function(data,K,Iter,Temp,cool){

  clusters &lt;- sample(1:K,nrow(data),replace = T) #initialise random clusters
  
  #clusters.o &lt;- clusters
  
  Es.old &lt;- calc.E.all(data,clusters)
  #E.old &lt;- E.tot(Es.old)
 
  for(i in 1:Iter){   # start iterating 
    
    clusters.new &lt;- clusters #copy the clusters
    #Es.new &lt;- Es.old
    
    row.id &lt;- sample(1:nrow(data),1) #pick a gene at random
    
    from.c &lt;- clusters.new[row.id] # get the cluster it&#39;s moving from
    #to.c &lt;- sample((1:K)[!(1:K) %in% from.c],1)
    to.c &lt;- sample((1:K)[-from.c],1) # randomly choose a new cluster
    
    clusters.new[row.id] &lt;-  to.c # replace the old cluster with the new
    
    Es.new &lt;- Es.old #make a copy of the energies vector
    # calc the energies of the two changed clusters
    Es.new[from.c] &lt;- calc.Ek(data,clusters.new,from.c) 
    Es.new[to.c] &lt;- calc.Ek(data,clusters.new,to.c)
    
    E.new &lt;- E.tot(Es.new) # calculate the new average E
    E.old &lt;- E.tot(Es.old) # calculate the old average E
    
    if(E.new &lt; E.old){  # if new &lt; old accept the move copy the new clusters into the previous
      clusters &lt;-  clusters.new #copy the new clusters into the previous
      Es.old &lt;- Es.new # make Enew to Eold
    }else{
      
      if(calc.exp(E.new,E.old,Temp) &gt; runif(1)){ #evaluate the exprssion against the random number from runif(1)
        clusters &lt;- clusters.new #copy the new clusters into the previous
        Es.old &lt;- Es.new  # make Enew to Eold
      }
    }
    
    {cat(&quot;\r&quot;,E.old)} #print out the energy to the screen
    
    Temp &lt;- Temp*cool # cool the system
  }
  clusters # return the clusters
}</code></pre>
<p>That is quite a lot and we should probably look into what this does.</p>
<p>Since the initial random cluster assignment is already done in new(), we now need to compute the energy of each cluster before proceeding with simulated annealing.</p>
<pre><code>    pub fn run( &amp;mut self, max_iter:usize, temp:f32, cool:f32 ) -&gt; usize {
    
      let mut it = 0;
      // calculate the inital energies - this will be modified later
      let mut old_energies= Vec::&lt;f32&gt;::with_capacity( self.k );
      for i in 0..self.k {
          old_energies.push( self.calc_ek( i ) );
      }
      
      let mut old_total: f32 = old_energies.iter().sum::&lt;f32&gt;() / self.k as f32;
      
      let mut rand = rand::rng();
      
      for _ in 0..max_iter{
          it += 1;
          // initate all varaibales
          let mut new_energies = old_energies.clone();
          let moving_row = rand.random_range(0..self.data.len());
          let move_from = self.clusters[moving_row];
          let mut move_to = rand.random_range(0..self.k);
          while move_from == move_to{
              move_to = rand.random_range(0..self.k);
          }
          // move the row from to
          self.clusters[moving_row] = move_to;
          // calculate the new energies
          new_energies[move_from] = self.calc_ek( move_from );
          new_energies[move_to] = self.calc_ek( move_to );
          
          let new_total:u32 = new_energies.iter().sum::&lt;f32&gt;() / self.k as f32;
          
          if new_total &lt; old_total || 
            (-((new_total - old_total) / self.temp)).exp() &gt; rand.random_range(0.0..1.0){
              // that is a good one - keep this
              old_energies[move_from] = new_energies[move_from];
              old_energies[move_to] = new_energies[move_to];
              old_total = new_total;
          }else {
              //this move was not good - drop it!
              self.clusters[moving_row] = move_from;
          }
          // cool the system and exit if it reached ~0
          self.temp *= cool;
          if self.temp &lt; 1e-8{
              break
          }
      }
      it
    }
    </code></pre>
</div>
<div id="and-funtions-to-plot-and-write-the-data" class="section level2 hasAnchor" number="4.4">
<h2><span class="header-section-number">4.4</span> And Funtions to Plot and Write the Data<a href="implement-the-simulated-annealing-algorithm.html#and-funtions-to-plot-and-write-the-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Here I’ll just give you the Rust code as this is something I also just copy pasted:</p>
<pre><code>use plotters::prelude::*;
use std::error::Error;
use std::io::Write;

    pub fn write_clusters(&amp;self, ofile: &amp;str, sep: char) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
        // Open the file in write mode
        let mut file = File::create(ofile)?;

        // Write the header (optional)
        writeln!(file, &quot;Rowname{}Cluster&quot;, sep)?;

        // Iterate over the rownames and clusters, writing them to the file
        for (rowname, cluster) in self.rownames.iter().zip(self.clusters.iter()) {
            writeln!(file, &quot;{}{}{}&quot;, rowname, sep, cluster+1)?;
        }

        Ok(())
    }
    
    pub fn plot(&amp;self, prefix:&amp;str )-&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
        let output_dir = Path::new(prefix).parent().unwrap_or_else(|| Path::new(&quot;.&quot;));
        std::fs::create_dir_all(output_dir)?;

        for cluster_id in 0..self.k {
            let filename = format!(&quot;{}_cluster_{}.png&quot;, prefix, cluster_id +1 );
            let root = BitMapBackend::new(&amp;filename, (800, 600)).into_drawing_area();
            root.fill(&amp;WHITE)?;

            let mut chart = ChartBuilder::on(&amp;root)
                .caption(format!(&quot;Cluster {}&quot;, cluster_id+1), (&quot;sans-serif&quot;, 20))
                .margin(20)
                .x_label_area_size(40)
                .y_label_area_size(40)
                .build_cartesian_2d(0..self.data[0].len(), 0.0f32..1.0)?; // Adjust Y range if needed

            chart.configure_mesh().draw()?;

            // Collect all rows belonging to this cluster
            let cluster_data: Vec&lt;&amp;Vec&lt;f32&gt;&gt; = self.data.iter()
                .zip(&amp;self.clusters)
                .filter(|&amp;(_, &amp;c)| c == cluster_id)
                .map(|(row, _)| row)
                .collect();

            // Draw each row as a line plot
            for row in cluster_data {
                chart.draw_series(LineSeries::new(
                    row.iter().enumerate().map(|(x, &amp;y)| (x, y)),
                    &amp;BLUE,
                ))?;
            }

            root.present()?;
            println!(&quot;Saved: {}&quot;, filename);
        }

        Ok(())
    }
</code></pre>
<p>The plot function needs one more library:</p>
<pre><code>cargo add plotters</code></pre>
<p>If all has gone well we could improve on our tests!
Add a second test case into the lib.rs file:</p>
<pre><code>    #[test]
    fn tes_scale01(){
        let mut obj = SimulatedAnnealing::new( &quot;tests/data/Spellman_Yeast_Cell_Cycle.tsv&quot;, 8, 1000.0, &#39;\t&#39; );
        obj.scale_01();
        let exp5:Vec&lt;f32&gt; = vec![0.6989,0.0000,0.0968,0.3333,0.4301,1.0000,0.7419,0.7419,0.6022,0.7634,0.1720,0.4301,0.5161,0.7634,0.6989,0.6559];
        let exp7:Vec&lt;f32&gt; = vec![0.0803,0.0000,0.2867,0.5849,0.9679,1.0000,0.7775,0.7156,0.5505,0.5459,0.4518,0.6193,0.8440,0.8532,0.9335,0.7752];
        let mut dist: f32 = 0.0;
        for i in 0..exp5.len() {
            assert!(
                (obj.data[5][i] - exp5[i]).abs() &lt; 1e-4,
                &quot;Mismatch in gene 5 at index {}: got {}, expected {}&quot;,
                i, obj.data[5][i], exp5[i]
            );
            assert!(
                (obj.data[7][i] - exp7[i]).abs() &lt; 1e-4,
                &quot;Mismatch in gene 7 at index {}: got {}, expected {}&quot;,
                i, obj.data[7][i], exp7[i]
            );
            dist += (obj.data[7][i]-obj.data[5][i]).powi(2);
        }
        dist = dist.sqrt();
        obj.clusters[5] = 8;
        obj.clusters[7] = 8;
        obj.k =9;
        assert_eq!( obj.calc_ek(8), dist, &quot;the distance in cluster 8 (genes 5 and 7)&quot; );
    }</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="implement-the-simulated-annealing-algorithm.html#cb10-1" tabindex="-1"></a><span class="fu">make</span> step3<span class="kw">|</span>  <span class="fu">sed</span> <span class="st">&#39;s/\x1B\[[0-9;]*m//g&#39;</span></span></code></pre></div>
<pre><code>## Building /home/med-sal/git_Projects/tutorial_rust_simulated_annealing/rust_stages/step3...
## warning: unused variable: `temp`
##    --&gt; src/lib.rs:128:44
##     |
## 128 |     pub fn run( &amp;mut self, max_iter:usize, temp:f32, cool:f32 ) -&gt; usize {
##     |                                            ^^^^ help: if this is intentional, prefix it with an underscore: `_temp`
##     |
##     = note: `#[warn(unused_variables)]` on by default
## 
## warning: `simulated_annealing` (lib) generated 1 warning
## warning: `simulated_annealing` (lib test) generated 1 warning (1 duplicate)
##     Finished ]8;;https://doc.rust-lang.org/cargo/reference/profiles.html#default-profiles\`release` profile [optimized]]8;;\ target(s) in 0.04s
##      Running unittests src/lib.rs (target/release/deps/simulated_annealing-ec0f849373011f09)
## 
## running 2 tests
## test tests::tes_scale01 ... ok
## test tests::test_read_data ... ok
## 
## test result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
## 
##      Running unittests src/main.rs (target/release/deps/simulated_annealing-34887cf23462f205)
## 
## running 0 tests
## 
## test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
## 
##      Running tests/test-SimulatedAnnealing.rs (target/release/deps/test_SimulatedAnnealing-fd16fac0ecee9aa3)
## 
## running 1 test
## test test_simulated_annealing ... ok
## 
## test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
## 
##    Doc-tests simulated_annealing
## 
## running 0 tests
## 
## test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
## 
## Finished building /home/med-sal/git_Projects/tutorial_rust_simulated_annealing/rust_stages/step3. Logs are in step3_build.log</code></pre>
<p>This looks good, just that we can not use this library as we have not implemented the executable :-D</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="implementation.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="main.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/USERNAME/REPO/edit/BRANCH/04-SimulatedAnnealing.Rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": ["_main.pdf", "_main.epub"],
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

</body>

</html>
