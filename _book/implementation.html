<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Implementation | Simulated Annealing in Rust</title>
  <meta name="description" content="<p>This Tutorial gives a short hands on example of how to read a table into Rust and run some calculations.
This should be a one day excercise and requires a previouse programming experience, but not necessarily Rust experience.</p>" />
  <meta name="generator" content="bookdown 0.42 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Implementation | Simulated Annealing in Rust" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="<p>This Tutorial gives a short hands on example of how to read a table into Rust and run some calculations.
This should be a one day excercise and requires a previouse programming experience, but not necessarily Rust experience.</p>" />
  <meta name="github-repo" content="stela2502/tutorial_rust_simulated_annealing" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Implementation | Simulated Annealing in Rust" />
  
  <meta name="twitter:description" content="<p>This Tutorial gives a short hands on example of how to read a table into Rust and run some calculations.
This should be a one day excercise and requires a previouse programming experience, but not necessarily Rust experience.</p>" />
  

<meta name="author" content="Stefan Lang" />


<meta name="date" content="2025-04-02" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="introduction.html"/>
<link rel="next" href="implement-the-simaulated-annealing-algorithm.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="using-rust-to-implement-the-simulatied-annealing-algorithm.html"><a href="using-rust-to-implement-the-simulatied-annealing-algorithm.html"><i class="fa fa-check"></i><b>1</b> Using Rust to Implement the Simulatied Annealing Algorithm</a>
<ul>
<li class="chapter" data-level="1.1" data-path="using-rust-to-implement-the-simulatied-annealing-algorithm.html"><a href="using-rust-to-implement-the-simulatied-annealing-algorithm.html#the-problem"><i class="fa fa-check"></i><b>1.1</b> The Problem</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="using-rust-to-implement-the-simulatied-annealing-algorithm.html"><a href="using-rust-to-implement-the-simulatied-annealing-algorithm.html#the-data"><i class="fa fa-check"></i><b>1.1.1</b> The Data</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="using-rust-to-implement-the-simulatied-annealing-algorithm.html"><a href="using-rust-to-implement-the-simulatied-annealing-algorithm.html#simulated-annealing"><i class="fa fa-check"></i><b>1.2</b> Simulated annealing</a></li>
<li class="chapter" data-level="1.3" data-path="using-rust-to-implement-the-simulatied-annealing-algorithm.html"><a href="using-rust-to-implement-the-simulatied-annealing-algorithm.html#the-algorithm"><i class="fa fa-check"></i><b>1.3</b> The Algorithm</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introduction.html"><a href="introduction.html#examples"><i class="fa fa-check"></i><b>2.1</b> Examples</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="introduction.html"><a href="introduction.html#integers"><i class="fa fa-check"></i><b>2.1.1</b> Integers</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="introduction.html"><a href="introduction.html#create-a-new-rust-program"><i class="fa fa-check"></i><b>2.2</b> Create a new Rust program</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="implementation.html"><a href="implementation.html"><i class="fa fa-check"></i><b>3</b> Implementation</a>
<ul>
<li class="chapter" data-level="3.1" data-path="implementation.html"><a href="implementation.html#there-is-a-lot-of-new-stuff-in-this-function"><i class="fa fa-check"></i><b>3.1</b> There is a lot of new stuff in this function:</a></li>
<li class="chapter" data-level="3.2" data-path="implementation.html"><a href="implementation.html#add-a-test-for-this"><i class="fa fa-check"></i><b>3.2</b> Add a test for this</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="implement-the-simaulated-annealing-algorithm.html"><a href="implement-the-simaulated-annealing-algorithm.html"><i class="fa fa-check"></i><b>4</b> Implement the Simaulated Annealing Algorithm</a>
<ul>
<li class="chapter" data-level="4.1" data-path="implement-the-simaulated-annealing-algorithm.html"><a href="implement-the-simaulated-annealing-algorithm.html#scaling-of-the-data"><i class="fa fa-check"></i><b>4.1</b> scaling of the data</a></li>
<li class="chapter" data-level="4.2" data-path="implement-the-simaulated-annealing-algorithm.html"><a href="implement-the-simaulated-annealing-algorithm.html#calculating-cluster-energy"><i class="fa fa-check"></i><b>4.2</b> Calculating Cluster Energy</a></li>
<li class="chapter" data-level="4.3" data-path="implement-the-simaulated-annealing-algorithm.html"><a href="implement-the-simaulated-annealing-algorithm.html#the-main-function"><i class="fa fa-check"></i><b>4.3</b> The main function</a></li>
<li class="chapter" data-level="4.4" data-path="implement-the-simaulated-annealing-algorithm.html"><a href="implement-the-simaulated-annealing-algorithm.html#and-funtions-to-plot-and-write-the-data"><i class="fa fa-check"></i><b>4.4</b> And Funtions to Plot and Write the Data</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="main.html"><a href="main.html"><i class="fa fa-check"></i><b>5</b> main.rs</a></li>
<li class="chapter" data-level="6" data-path="sharing-your-book.html"><a href="sharing-your-book.html"><i class="fa fa-check"></i><b>6</b> Sharing your book</a>
<ul>
<li class="chapter" data-level="6.1" data-path="sharing-your-book.html"><a href="sharing-your-book.html#publishing"><i class="fa fa-check"></i><b>6.1</b> Publishing</a></li>
<li class="chapter" data-level="6.2" data-path="sharing-your-book.html"><a href="sharing-your-book.html#pages"><i class="fa fa-check"></i><b>6.2</b> 404 pages</a></li>
<li class="chapter" data-level="6.3" data-path="sharing-your-book.html"><a href="sharing-your-book.html#metadata-for-sharing"><i class="fa fa-check"></i><b>6.3</b> Metadata for sharing</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="chapter" data-level="7" data-path="error-handling.html"><a href="error-handling.html"><i class="fa fa-check"></i><b>7</b> Error Handling in Rust</a>
<ul>
<li class="chapter" data-level="7.1" data-path="error-handling.html"><a href="error-handling.html#unrecoverable-errors-panic"><i class="fa fa-check"></i><b>7.1</b> 1. Unrecoverable Errors (<code>panic!</code>)</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="error-handling.html"><a href="error-handling.html#example"><i class="fa fa-check"></i><b>7.1.1</b> Example:</a></li>
<li class="chapter" data-level="7.1.2" data-path="error-handling.html"><a href="error-handling.html#when-to-use-panic"><i class="fa fa-check"></i><b>7.1.2</b> When to Use <code>panic!()</code></a></li>
<li class="chapter" data-level="7.1.3" data-path="error-handling.html"><a href="error-handling.html#handling-panics-gracefully"><i class="fa fa-check"></i><b>7.1.3</b> Handling Panics Gracefully</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="error-handling.html"><a href="error-handling.html#recoverable-errors-resultt-e"><i class="fa fa-check"></i><b>7.2</b> 2. Recoverable Errors (<code>Result&lt;T, E&gt;</code>)</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="error-handling.html"><a href="error-handling.html#example-1"><i class="fa fa-check"></i><b>7.2.1</b> Example:</a></li>
<li class="chapter" data-level="7.2.2" data-path="error-handling.html"><a href="error-handling.html#resultt-e-explanation"><i class="fa fa-check"></i><b>7.2.2</b> <code>Result&lt;T, E&gt;</code> Explanation</a></li>
<li class="chapter" data-level="7.2.3" data-path="error-handling.html"><a href="error-handling.html#common-ways-to-handle-resultt-e"><i class="fa fa-check"></i><b>7.2.3</b> Common Ways to Handle <code>Result&lt;T, E&gt;</code></a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="error-handling.html"><a href="error-handling.html#custom-errors-with-thiserror-and-anyhow"><i class="fa fa-check"></i><b>7.3</b> 3. Custom Errors with <code>thiserror</code> and <code>anyhow</code></a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="error-handling.html"><a href="error-handling.html#using-thiserror-for-custom-errors"><i class="fa fa-check"></i><b>7.3.1</b> Using <code>thiserror</code> for Custom Errors</a></li>
<li class="chapter" data-level="7.3.2" data-path="error-handling.html"><a href="error-handling.html#using-anyhow-for-simpler-error-handling"><i class="fa fa-check"></i><b>7.3.2</b> Using <code>anyhow</code> for Simpler Error Handling</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="error-handling.html"><a href="error-handling.html#summary-of-rust-error-handling-techniques"><i class="fa fa-check"></i><b>7.4</b> Summary of Rust Error Handling Techniques</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="testing.html"><a href="testing.html"><i class="fa fa-check"></i><b>8</b> Testing in Rust</a>
<ul>
<li class="chapter" data-level="8.1" data-path="testing.html"><a href="testing.html#writing-basic-unit-tests"><i class="fa fa-check"></i><b>8.1</b> 1. Writing Basic Unit Tests</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="testing.html"><a href="testing.html#example-2"><i class="fa fa-check"></i><b>8.1.1</b> Example:</a></li>
<li class="chapter" data-level="8.1.2" data-path="testing.html"><a href="testing.html#common-assertions"><i class="fa fa-check"></i><b>8.1.2</b> Common Assertions:</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="testing.html"><a href="testing.html#running-tests"><i class="fa fa-check"></i><b>8.2</b> 2. Running Tests</a></li>
<li class="chapter" data-level="8.3" data-path="testing.html"><a href="testing.html#testing-for-panics"><i class="fa fa-check"></i><b>8.3</b> 3. Testing for Panics</a></li>
<li class="chapter" data-level="8.4" data-path="testing.html"><a href="testing.html#using-resultt-e-in-tests"><i class="fa fa-check"></i><b>8.4</b> 4. Using <code>Result&lt;T, E&gt;</code> in Tests</a></li>
<li class="chapter" data-level="8.5" data-path="testing.html"><a href="testing.html#ignoring-tests"><i class="fa fa-check"></i><b>8.5</b> 5. Ignoring Tests</a></li>
<li class="chapter" data-level="8.6" data-path="testing.html"><a href="testing.html#benchmarking-with-bench"><i class="fa fa-check"></i><b>8.6</b> 6. Benchmarking with <code>#[bench]</code></a></li>
<li class="chapter" data-level="8.7" data-path="testing.html"><a href="testing.html#integration-tests"><i class="fa fa-check"></i><b>8.7</b> 7. Integration Tests</a>
<ul>
<li class="chapter" data-level="8.7.1" data-path="testing.html"><a href="testing.html#example-testsintegration_test.rs"><i class="fa fa-check"></i><b>8.7.1</b> Example <code>tests/integration_test.rs</code>:</a></li>
</ul></li>
<li class="chapter" data-level="8.8" data-path="testing.html"><a href="testing.html#testing-the-executable"><i class="fa fa-check"></i><b>8.8</b> 8. Testing the Executable</a>
<ul>
<li class="chapter" data-level="8.8.1" data-path="testing.html"><a href="testing.html#example-teststest_binary.rs"><i class="fa fa-check"></i><b>8.8.1</b> Example <code>tests/test_binary.rs</code>:</a></li>
</ul></li>
<li class="chapter" data-level="8.9" data-path="testing.html"><a href="testing.html#summary"><i class="fa fa-check"></i><b>8.9</b> Summary</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Simulated Annealing in Rust</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="implementation" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">Chapter 3</span> Implementation<a href="implementation.html#implementation" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Now letâ€™s look into creating a Rust package that executes a Simulated Annealing based Clustering on a text table of numeric values.</p>
<p>First we will create a new package structure for your tool:</p>
<pre><code>cargo new --bin simulated_annealing</code></pre>
<p>This will create the folder, populate it with some files and prepare it for git usage.
For later use we create a simulated_annealing/tests folder and a simulated_annealing/src/lib.rs file.</p>
<p>I normally put as much code into the library and keep the script as slender as possible.</p>
<p>Which data structures do we need?</p>
<ol style="list-style-type: decimal">
<li>The â€˜expressionâ€™ data</li>
<li>The rows &lt;-&gt; cluster connections</li>
<li>The number of clusters asked for</li>
<li>The actual temperature of the system</li>
</ol>
<p>** Letâ€™s create the object**</p>
<p>Open the src/lib.rs file and add this:</p>
<pre><code>
pub struct SimulatedAnnealing {
    /// the normalized expression data
    pub data: Vec&lt;Vec&lt;f32&gt;&gt;,
    /// the names for each row
    rownames: Vec&lt;String&gt;,
    /// the cluster ids for each row of data
    clusters: Vec&lt;usize&gt;,
    /// expected clusters k
    k: usize,
    /// the actual temerature
    temp:f32,

}
impl SimulatedAnnealing {
    pub fn new( file_path:&amp;str, k:usize, temp:f32, split:char ) -&gt; Self{

        let (rownames, data) = Self::read_table_with_names( file_path, split ).unwrap();

        let clusters: Vec&lt;usize&gt; = rownames.iter().map(|_| rand::thread_rng().gen_range(1..=k)).collect();

        Self{
            data,
            rownames,
            clusters,
            clusters_energy: vec![0.0; k ],
            temp,
        }
    }
}
</code></pre>
<p>This will define a class with the variables data, rownames, clusters, k and temp as well as the new() function for this class, which in turn populates these variables with initial values. Save the file and try to compile your project using</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="implementation.html#cb3-1" tabindex="-1"></a><span class="fu">make</span> step1 <span class="kw">|</span>  <span class="fu">sed</span> <span class="st">&#39;s/\x1B\[[0-9;]*m//g&#39;</span></span></code></pre></div>
<pre><code>## Building /home/med-sal/git_Projects/tutorial_rust_simulated_annealing/rust_stages/step1...
##    Compiling simulated_annealing v0.1.0 (/home/med-sal/git_Projects/tutorial_rust_simulated_annealing/rust_stages/step1)
## error[E0599]: no function or associated item named `read_table_with_names` found for struct `SimulatedAnnealing` in the current scope
##   --&gt; src/lib.rs:21:38
##    |
## 2  | pub struct SimulatedAnnealing {
##    | ----------------------------- function or associated item `read_table_with_names` not found for this struct
## ...
## 21 |         let (rownames, data) = Self::read_table_with_names( file_path, split ).unwrap();
##    |                                      ^^^^^^^^^^^^^^^^^^^^^ function or associated item not found in `SimulatedAnnealing`
##    |
## note: if you&#39;re trying to build a new `SimulatedAnnealing`, consider using `SimulatedAnnealing::new` which returns `SimulatedAnnealing`
##   --&gt; src/lib.rs:19:5
##    |
## 19 |     pub fn new( file_path:&amp;str, k:usize, temp:f32, split:char ) -&gt; Self{
##    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
## 
## error[E0433]: failed to resolve: use of undeclared crate or module `rand`
##   --&gt; src/lib.rs:23:60
##    |
## 23 |         let clusters: Vec&lt;usize&gt; = rownames.iter().map(|_| rand::thread_rng().gen_range(0..k)).collect();
##    |                                                            ^^^^ use of undeclared crate or module `rand`
## 
## Some errors have detailed explanations: E0433, E0599.
## For more information about an error, try `rustc --explain E0433`.
## error: could not compile `simulated_annealing` (lib) due to 2 previous errors
## warning: build failed, waiting for other jobs to finish...
## error: could not compile `simulated_annealing` (lib test) due to 2 previous errors
## Finished building /home/med-sal/git_Projects/tutorial_rust_simulated_annealing/rust_stages/step1. Logs are in step1_build.log</code></pre>
<p>Right - we try to create the random cluster info and have not loaded the required package. That is simple to do in Rust:</p>
<pre><code>cargo add rand</code></pre>
<p>Do not forget to also load that library into the lib.rs. I the top of that file add <code>use rand;</code>.</p>
<p>The read_table function is more complicated.
I normally out-source these simple, but tedious steps to ChatGPT or an other AI helper, but these are the steps we need to take:</p>
<ol style="list-style-type: decimal">
<li>create a Path from the &amp;str file_name</li>
<li>open that Path</li>
<li>create a BuffReader from that File to more efficiently read from it</li>
<li>iterate over the lines and</li>
<li>split the line by sep (could be user defined too - or?)</li>
<li>use the first entry as rowname (String) and the rest as numeric (f32).</li>
</ol>
<p>Add this new function to your class:</p>
<pre><code>use std::path::Path;
use std::fs::File;
use std::io::{BufReader, BuffRead};
use rand::Rng;
    pub fn read_table_with_names(file_path: &amp;str, split: char ) -&gt; Result&lt;( Vec&lt;String&gt;, Vec&lt;Vec&lt;f32&gt;&gt;), String&gt; {
        let path = Path::new(file_path);
        let file = match File::open(path){
          Ok(f) =&gt; f,
          Err(e) =&gt; {
            return Err( format!(&quot;Failed to open file: {}&quot;, e) )
          }
        };
        let reader = BufReader::new(file);

        let mut data = Vec::new();
        let mut rownames= Vec::new();

        for (line_num, line) in reader.lines().enumerate() {
            let line = line.map_err(|e| format!(&quot;Error reading line {}: {}&quot;, line_num + 1, e))?;
            let mut parts = line.split( split );

            let row_name = parts.next().ok_or_else(|| format!(&quot;Missing row name at line {}&quot;, line_num + 1))?;
            if row_name == &quot;&quot; {
                // ignore column names
                continue;
            }
            rownames.push( row_name.to_string() );

            let values: Result&lt;Vec&lt;f32&gt;, String&gt; = parts
                .map(|num| num.parse::&lt;f32&gt;().map_err(|_| format!(&quot;Invalid number &#39;{}&#39; at line {}&quot;, num, line_num + 1)))
                .collect();

            let values = values.unwrap(); // will die on error
            data.push( values );
        }

        Ok( (rownames,data) )
    }</code></pre>
<div id="there-is-a-lot-of-new-stuff-in-this-function" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> There is a lot of new stuff in this function:<a href="implementation.html#there-is-a-lot-of-new-stuff-in-this-function" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The return type - what is a Result&lt;( Vec<String>, Vec&lt;Vec<f32>&gt;), String&gt;?
This allows us to fail on the task. We can this way either return the tupel with the two vectors or a String,
that would contain our error message(s). We create our error in four positions in our function: (1) when trying to open the
file using a match construct (2) when reading a line from the file using map_err (3) getting the rowname using ok_or_else and finally (4) when a value in the table can not be converted to a f32 number using map_err again.</p>
<p>Why are there so many ways to create the error? I actually asked Chatty exactly that and you can read the rather long answer here: <a href="error-handling.html#error-handling">7</a>.</p>
<p>In Short there are Results that allow for an error being returned if something fails and an Option which only allows None to be returned is something fails. For more info please read that: <a href="error-handling.html#error-handling">7</a>.</p>
<p>So if we re-compile this - will it work? If not just follow the compilerâ€™s help ;-)</p>
</div>
<div id="add-a-test-for-this" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> Add a test for this<a href="implementation.html#add-a-test-for-this" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>At the moment the library does just compile - we have no way to test it.</p>
<p>It is highly advisable to add tests for as many functions as you can! I asked Chatty for some text again and you can red it here: <a href="testing.html#testing">8</a>. For the private read_table_with_names function we should create a unit test in the same file as the function. At the end of the file - outside the class functions block add this:</p>
<pre><code>#[cfg(test)]
mod tests {
    use super::*; // Import everything from the parent module

    #[test]
    fn test_read_data() {
        match SimulatedAnnealing::read_table_with_names( &quot;tests/data/Spellman_Yeast_Cell_Cycle.tsv&quot;, &#39;\t&#39; ){
            Ok((rownames, data)) =&gt; {
                assert_eq!(data.len(), 256, &quot;we have 256 rows&quot;);
                assert_eq!(data[0].len(), 16, &quot;we have 16 cols&quot;);
                assert_eq!(rownames.len(), data.len(), &quot;rownames and data have the same dimension (isch)&quot;)
            }Err(e) =&gt;{
                panic!(&quot;Could not read the tsv file! : {e}&quot;);
            }
        }
    }
}</code></pre>
<p>For this to work we need to create the folder in our package and download <a href="https://github.com/shambam/R_programming_1/raw/refs/heads/main/Spellman_Yeast_Cell_Cycle.tsv">this file</a> there.</p>
<pre><code>mkdir -p tests/data
wget https://github.com/shambam/R_programming_1/raw/refs/heads/main/Spellman_Yeast_Cell_Cycle.tsv -O tests/data/Spellman_Yeast_Cell_Cycle.tsv</code></pre>
<p>Now you can compile and test the reading of the data:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="implementation.html#cb9-1" tabindex="-1"></a><span class="co"># you run this: cargo test -r</span></span>
<span id="cb9-2"><a href="implementation.html#cb9-2" tabindex="-1"></a></span>
<span id="cb9-3"><a href="implementation.html#cb9-3" tabindex="-1"></a><span class="fu">make</span> step2 <span class="kw">|</span>  <span class="fu">sed</span> <span class="st">&#39;s/\x1B\[[0-9;]*m//g&#39;</span></span></code></pre></div>
<pre><code>## Building /home/med-sal/git_Projects/tutorial_rust_simulated_annealing/rust_stages/step2...
##     Finished ]8;;https://doc.rust-lang.org/cargo/reference/profiles.html#default-profiles\`release` profile [optimized]]8;;\ target(s) in 0.04s
##      Running unittests src/lib.rs (target/release/deps/simulated_annealing-ec0f849373011f09)
## 
## running 1 test
## test tests::test_read_data ... ok
## 
## test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
## 
##      Running unittests src/main.rs (target/release/deps/simulated_annealing-34887cf23462f205)
## 
## running 0 tests
## 
## test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
## 
##    Doc-tests simulated_annealing
## 
## running 0 tests
## 
## test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
## 
## Finished building /home/med-sal/git_Projects/tutorial_rust_simulated_annealing/rust_stages/step2. Logs are in step2_build.log</code></pre>
<p>Cool! First class first class function and first test - and everything is working - or?</p>
<p>Lets also add a test for the new function. This function should be accessible from outside and therefore we should create a new test file. Create the file <code>tests/test-SimulatedAnnealing.rs</code> and fill it with this:</p>
<pre><code>use simulated_annealing::SimulatedAnnealing; // Replace `my_crate` with your actual crate name

#[test]
fn test_simulated_annealing() {
    let sa = SimulatedAnnealing::new( &quot;tests/data/Spellman_Yeast_Cell_Cycle.tsv&quot;, 10, 200.0, &#39;\t&#39; ); // Assuming `new()` is implemented
    assert_eq!(sa.data.len(), 256, &quot;we have 256 rows&quot;);
    assert_eq!(sa.data[0].len(), 16, &quot;we have 16 cols&quot;);
}</code></pre>
<p>Test this again.</p>
<p>So all that is left is to implement the main simulated annealing algorithm. Should be rather simple.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="introduction.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="implement-the-simaulated-annealing-algorithm.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/USERNAME/REPO/edit/BRANCH/03-read_data.Rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": ["_main.pdf", "_main.epub"],
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

</body>

</html>
